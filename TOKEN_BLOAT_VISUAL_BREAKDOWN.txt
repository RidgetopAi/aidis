═══════════════════════════════════════════════════════════════════════════════
  MCP TOOL TOKEN BLOAT VISUAL BREAKDOWN
═══════════════════════════════════════════════════════════════════════════════

INVESTIGATION FINDING: 560 tokens per tool (Partner measurement)
OUR SCHEMAS: 53 tokens per tool (Actual measurement)
BLOAT SOURCE: Claude Code internal conversion (~507 tokens overhead)

───────────────────────────────────────────────────────────────────────────────
  TOKEN FLOW ANALYSIS
───────────────────────────────────────────────────────────────────────────────

┌─────────────────────────────────────────────────────────────────────────────┐
│ 1. AIDIS TOOL DEFINITION (toolDefinitions.ts)                              │
│    ┌─────────────────────────────────────────────┐                          │
│    │ {                                           │                          │
│    │   name: "aidis_ping",                       │                          │
│    │   description: "Test connectivity...",      │                          │
│    │   inputSchema: {                            │                          │
│    │     type: "object",                         │                          │
│    │     properties: { ... },                    │                          │
│    │     additionalProperties: true              │                          │
│    │   }                                         │                          │
│    │ }                                           │                          │
│    └─────────────────────────────────────────────┘                          │
│    📊 Token Count: 53 tokens (212 chars)                                    │
└─────────────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 2. MCP SDK WRAPPER (server.ts ListToolsRequestSchema)                      │
│    ┌─────────────────────────────────────────────┐                          │
│    │ {                                           │                          │
│    │   "tools": [                                │                          │
│    │     {                                       │                          │
│    │       name: "aidis_ping",                   │                          │
│    │       description: "Test connectivity...",  │                          │
│    │       inputSchema: { ... }                  │                          │
│    │     }                                       │                          │
│    │   ]                                         │                          │
│    │ }                                           │                          │
│    └─────────────────────────────────────────────┘                          │
│    📊 Token Count: 86 tokens (+33 for MCP wrapper)                          │
└─────────────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 3. STDIO TRANSPORT (MCP Protocol over stdin/stdout)                        │
│    ┌─────────────────────────────────────────────┐                          │
│    │ JSON-RPC 2.0 message with tool schemas     │                          │
│    │ Transmitted over STDIO to Claude Code      │                          │
│    └─────────────────────────────────────────────┘                          │
│    📊 Token Count: 86 tokens (no additional overhead)                       │
└─────────────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 4. CLAUDE CODE INTERNAL PROCESSING ⚠️ BLOAT SOURCE ⚠️                      │
│                                                                             │
│    ┌────────────────────────────────────────────────────────────────┐      │
│    │ FUNCTION CALLING CONVERSION (~200 tokens)                      │      │
│    │ • MCP JSON Schema → Claude Function Schema                     │      │
│    │ • Add required/optional metadata                               │      │
│    │ • Expand type validation rules                                 │      │
│    │ • Parameter constraint documentation                           │      │
│    └────────────────────────────────────────────────────────────────┘      │
│                                                                             │
│    ┌────────────────────────────────────────────────────────────────┐      │
│    │ UI PRESENTATION METADATA (~150 tokens)                         │      │
│    │ • Tool category/grouping tags                                  │      │
│    │ • Usage examples/hints                                         │      │
│    │ • Parameter default values                                     │      │
│    │ • Validation error messages                                    │      │
│    └────────────────────────────────────────────────────────────────┘      │
│                                                                             │
│    ┌────────────────────────────────────────────────────────────────┐      │
│    │ MCP PROTOCOL METADATA (~100 tokens)                            │      │
│    │ • Server identification (name: "aidis-mcp-server")             │      │
│    │ • Capability declarations                                      │      │
│    │ • Transport layer information                                  │      │
│    │ • Connection state metadata                                    │      │
│    └────────────────────────────────────────────────────────────────┘      │
│                                                                             │
│    ┌────────────────────────────────────────────────────────────────┐      │
│    │ INTERNAL OPTIMIZATION (~21 tokens)                             │      │
│    │ • Caching keys                                                 │      │
│    │ • Performance hints                                            │      │
│    │ • Error handling rules                                         │      │
│    │ • Retry policies                                               │      │
│    └────────────────────────────────────────────────────────────────┘      │
│                                                                             │
│    📊 Token Count: 560 tokens (+474 Claude Code overhead)                  │
└─────────────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 5. CLAUDE CODE TOOL DISPLAY                                                │
│    ┌─────────────────────────────────────────────┐                          │
│    │ mcp__aidis__aidis_ping: 562 tokens          │                          │
│    │ mcp__aidis__context_store: 558 tokens       │                          │
│    │ mcp__aidis__project_list: 558 tokens        │                          │
│    └─────────────────────────────────────────────┘                          │
│    📊 Partner Measurement: ~560 tokens average                              │
└─────────────────────────────────────────────────────────────────────────────┘

───────────────────────────────────────────────────────────────────────────────
  TOKEN OVERHEAD BREAKDOWN (Per Tool)
───────────────────────────────────────────────────────────────────────────────

┌────────────────────────────┬───────────┬──────────────────────────────────┐
│ Layer                      │  Tokens   │ Description                      │
├────────────────────────────┼───────────┼──────────────────────────────────┤
│ AIDIS Schema               │    53     │ Our optimized tool definition    │
│ MCP Protocol Wrapper       │   +33     │ {"tools":[...]} wrapper          │
│ Name Prefix                │    +3     │ "mcp__aidis__" prefix            │
│ Claude Code Conversion     │  +471     │ Internal function calling format │
├────────────────────────────┼───────────┼──────────────────────────────────┤
│ TOTAL PER TOOL             │   560     │ What partner sees in Claude Code │
└────────────────────────────┴───────────┴──────────────────────────────────┘

───────────────────────────────────────────────────────────────────────────────
  IMPACT ANALYSIS (41 Active Tools)
───────────────────────────────────────────────────────────────────────────────

Expected Token Usage:   41 tools × 86 tokens  =  3,526 tokens  ( 1.8% of 200K)
Actual Token Usage:     41 tools × 560 tokens = 22,960 tokens  (11.5% of 200K)
                                                ────────────────────────────────
Hidden Overhead:                                19,434 tokens  ( 9.7% wasted!)

                        ┌───────────────────────────────┐
                        │  WASTED TOKEN CAPACITY        │
                        │  19,434 tokens per session    │
                        │  Could be used for context!   │
                        └───────────────────────────────┘

───────────────────────────────────────────────────────────────────────────────
  VISUAL COMPARISON
───────────────────────────────────────────────────────────────────────────────

Our Schema (53 tokens):
█

MCP Wrapper (+33 tokens):
█▓

Claude Code Display (560 tokens):
█▓▓▓▓▓▓▓▓▓▓  <-- 955% overhead!

Legend:
█ = AIDIS optimized schema (controllable)
▓ = External overhead (uncontrollable)

───────────────────────────────────────────────────────────────────────────────
  OPTIMIZATION STATUS
───────────────────────────────────────────────────────────────────────────────

✅ AIDIS Schemas:         FULLY OPTIMIZED (53 tokens)
✅ Tool Count:            REDUCED (52 → 41 tools, -21%)
✅ Schema Simplification: COMPLETE (Phase 3 TT009)

❌ MCP Protocol:          FIXED OVERHEAD (33 tokens, cannot reduce)
❌ Name Prefix:           REQUIRED (3 tokens, cannot remove)
❌ Claude Code:           INTERNAL BLOAT (471 tokens, beyond our control)

───────────────────────────────────────────────────────────────────────────────
  CONCLUSION
───────────────────────────────────────────────────────────────────────────────

ROOT CAUSE:  Claude Code's internal MCP-to-function-calling conversion
BLOAT:       507 tokens per tool (955% overhead)
ACTIONABLE:  No further AIDIS-side optimization possible
STATUS:      Investigation complete - schemas are optimal

RECOMMENDATION: Accept 560 tokens/tool as baseline, continue strategic tool
                management, report finding to Anthropic for potential future
                optimization in Claude Code internals.

═══════════════════════════════════════════════════════════════════════════════
  Investigation Date: 2025-10-01
  Report: MCP_TOKEN_BLOAT_INVESTIGATION_REPORT.md
═══════════════════════════════════════════════════════════════════════════════
