<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Frontend Project Context</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .debug-output { background: #f5f5f5; padding: 10px; white-space: pre-wrap; }
        button { margin: 5px; padding: 8px 15px; }
    </style>
</head>
<body>
    <h1>üîç Debug Frontend Project Context</h1>
    
    <div class="debug-section">
        <h3>Authentication Status</h3>
        <div id="auth-status" class="debug-output">Loading...</div>
    </div>
    
    <div class="debug-section">
        <h3>Current Project</h3>
        <div id="current-project" class="debug-output">Loading...</div>
    </div>
    
    <div class="debug-section">
        <h3>All Projects</h3>
        <div id="all-projects" class="debug-output">Loading...</div>
    </div>
    
    <div class="debug-section">
        <h3>Actions</h3>
        <button onclick="setAidisBootstrapProject()">Set aidis-bootstrap Project</button>
        <button onclick="testDecisionSearch()">Test Decision Search</button>
        <button onclick="refreshAll()">Refresh All Data</button>
    </div>
    
    <div class="debug-section">
        <h3>Decision Search Results</h3>
        <div id="decision-results" class="debug-output">Click "Test Decision Search" to see results</div>
    </div>

    <script>
        let currentToken = null;
        let currentProject = null;
        let allProjects = [];

        async function login() {
            try {
                const response = await fetch('http://localhost:5001/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123!' })
                });
                const data = await response.json();
                currentToken = data.token;
                return currentToken;
            } catch (error) {
                console.error('Login failed:', error);
                return null;
            }
        }

        async function loadProjects() {
            if (!currentToken) await login();
            
            try {
                const response = await fetch('http://localhost:5001/api/projects', {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();
                allProjects = data.data?.projects || [];
                return allProjects;
            } catch (error) {
                console.error('Failed to load projects:', error);
                return [];
            }
        }

        async function setAidisBootstrapProject() {
            await loadProjects();
            const aidisBootstrap = allProjects.find(p => p.name === 'aidis-bootstrap');
            if (aidisBootstrap) {
                currentProject = aidisBootstrap;
                localStorage.setItem('aidis_current_project', JSON.stringify(currentProject));
                updateDisplay();
                console.log('Set aidis-bootstrap as current project');
            } else {
                console.error('aidis-bootstrap project not found');
            }
        }

        async function testDecisionSearch() {
            if (!currentToken) await login();
            if (!currentProject) {
                document.getElementById('decision-results').textContent = 'No current project set!';
                return;
            }

            try {
                const response = await fetch(
                    `http://localhost:5001/api/decisions?query=system&project_id=${currentProject.id}`,
                    { headers: { 'Authorization': `Bearer ${currentToken}` } }
                );
                const data = await response.json();
                
                document.getElementById('decision-results').textContent = 
                    `Success: ${data.success}\n` +
                    `Total Found: ${data.data?.total || 0}\n` +
                    `Decisions Returned: ${data.data?.decisions?.length || 0}\n` +
                    `Message: ${data.message}\n\n` +
                    `Sample Decision:\n${JSON.stringify(data.data?.decisions?.[0] || 'None', null, 2)}`;
            } catch (error) {
                document.getElementById('decision-results').textContent = `Error: ${error.message}`;
            }
        }

        async function refreshAll() {
            await login();
            await loadProjects();
            
            // Try to load from localStorage
            try {
                const stored = localStorage.getItem('aidis_current_project');
                if (stored) {
                    currentProject = JSON.parse(stored);
                }
            } catch (error) {
                console.error('Failed to load from localStorage:', error);
            }
            
            updateDisplay();
        }

        function updateDisplay() {
            document.getElementById('auth-status').textContent = 
                currentToken ? `Authenticated: ${currentToken.substring(0, 20)}...` : 'Not authenticated';
            
            document.getElementById('current-project').textContent = 
                currentProject ? JSON.stringify(currentProject, null, 2) : 'No current project';
            
            document.getElementById('all-projects').textContent = 
                allProjects.length > 0 ? 
                `Found ${allProjects.length} projects:\n${allProjects.map(p => `- ${p.name} (${p.id})`).join('\n')}` :
                'No projects loaded';
        }

        // Initialize on page load
        refreshAll();
    </script>
</body>
</html>
